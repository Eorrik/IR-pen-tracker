技术规格说明书：基于双目红外泛光的被动式笔触追踪算法1. 概述本模块旨在通过双目立体视觉原理，处理由 Intel RealSense D435（配合物理扩散板）采集的红外图像数据，解算被动式反光笔在三维空间中的精确位姿。算法的核心目标是从左右两个红外相机视口中提取高对比度的漫反射光斑，通过亚像素级质心定位和三角测量，输出笔尖（Tip）与笔尾（Tail）的 3D 坐标及笔身方向向量。2. 算法输入定义算法接收以下原始数据流作为输入：左红外图像 (Left IR Image)：8-bit 灰度图，包含两个高亮反光光斑。右红外图像 (Right IR Image)：8-bit 灰度图，包含两个高亮反光光斑。相机内参 (Intrinsics)：焦距 ($f_x, f_y$) 和光心 ($c_x, c_y$)。相机外参 (Extrinsics)：左右相机之间的基线距离 ($Baseline$)。3. 核心算法流程第一阶段：2D 特征提取 (针对单目图像)对左、右红外图像分别执行相同的处理流程，以提取光斑的像素坐标。高通阈值分割利用反光贴纸在泛光照明下远高于背景的亮度特性，应用全局亮度阈值过滤图像。保留高亮区域，剔除背景噪声，生成二值化掩码或保留原始高亮灰度值。连通域分析 (Blob Detection)对高亮区域进行连通性分析，识别独立的团块（Blob）。预期输入：每帧图像中应当检测到2个主要团块（对应笔身上的两个反光点）。亚像素质心计算 (灰度加权法)为了处理扩散板带来的柔和光斑边界并获得高于像素网格的精度，禁止使用简单的几何中心。必须采用灰度加权质心算法 (Intensity-Weighted Centroid) 计算光斑中心 $(C_x, C_y)$：利用光斑内部像素的灰度值作为权重，灰度值越高的像素对质心位置的贡献越大。这确保了即使光斑形态发生微小变化，计算出的能量中心依然稳定。第二阶段：双目立体匹配将左图的两个点与右图的两个点进行对应。极线约束匹配 (Epipolar Constraint)利用经过校正的双目图像特性：空间中同一点在左右图像上的投影，其 Y 轴坐标应当高度近似。排序匹配策略：将左图的两个光斑按 Y 轴坐标排序（上点、下点）。将右图的两个光斑按 Y 轴坐标排序（上点、下点）。左图的上点匹配右图的上点；左图的下点匹配右图的下点。第三阶段：3D 空间重建 (三角测量)对每一对匹配好的光斑点 $(u_L, v_L)$ 和 $(u_R, v_R)$ 执行深度解算。视差计算 (Disparity)计算水平视差 $d = u_L - u_R$。深度映射 (Depth Calculation)根据公式 $Z = \frac{f \cdot B}{d}$ 计算该点距离相机的垂直深度 $Z$。其中 $f$ 为焦距，$B$ 为基线长度。3D 反投影 (Reprojection)结合内参矩阵，将图像平面的 2D 坐标 $(u, v)$ 和计算出的深度 $Z$，还原为摄像机坐标系下的 3D 坐标 $(X, Y, Z)$。第四阶段：几何解析与笔身定义根据计算出的两个 3D 坐标点 $P_1(x,y,z)$ 和 $P_2(x,y,z)$，确定笔的物理属性。笔尖/笔尾判定 (Top-Down Constraint)依据物理设定的严格 Top/Down 姿态约束（即笔始终大致垂直于地面或保持特定握持角度）。在摄像机坐标系中（假设 Y 轴向下为正）：Y 值较大的点（空间位置更靠下）被定义为 笔尖 (Tip)。Y 值较小的点（空间位置更靠上）被定义为 笔尾 (Tail)。向量构建笔身向量：构建从笔尖指向笔尾的单位向量 $\vec{V} = Normalize(P_{tail} - P_{tip})$。中点位置：计算笔身几何中心 $P_{mid} = \frac{P_{tip} + P_{tail}}{2}$。4. 输出数据规范算法最终输出包含以下物理含义的数据结构：Tip Position: 笔尖在相机坐标系下的 $(x, y, z)$ 坐标。Tail Position: 笔尾在相机坐标系下的 $(x, y, z)$ 坐标。Stylus Vector: 描述笔身倾斜方向的归一化向量 $(i, j, k)$。Quality Confidence: 基于光斑亮度、圆度和左右匹配误差的置信度评分。