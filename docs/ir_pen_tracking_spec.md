# IR Pen Tracking Specification (Cylinder Fitting Approach)

本文档详细描述基于高反贴纸与圆柱拟合的毛笔追踪算法。

## 1. 问题背景 (Problem Statement)

- **优势**: 使用了高质量的 IR 反射贴纸，在 IR 图像中亮度极高（接近饱和 65535）。这使得在 2D 图像平面上定位标记点（Marker）非常容易且精确，只需极高的阈值（如 > 60000）即可过滤绝大多数环境光干扰。
- **劣势**: ToF（Time-of-Flight）深度相机对于高反射率物体（Retro-reflective material）极其敏感。强反射会导致信号饱和或多径干扰，使得 **标记点本身的深度读数非常不准确**（往往比实际距离近，或者直接为 0）。
- **几何约束**: 毛笔笔杆是一个刚体圆柱。虽然标记点的深度不可靠，但**两个标记点之间的笔杆部分**通常是普通材质（塑料/木头），其深度读数是相对准确的。

## 2. 算法核心思想 (Core Concept)

算法不再直接信赖 Marker 处的深度值，而是利用 Marker 确定的 2D 直线，在深度图中寻找该直线路径上的“笔杆点云”，通过拟合 3D 直线（圆柱轴线）来恢复 Marker 的真实 3D 位置。

## 3. 详细步骤 (Algorithm Steps)

### 3.1 2D 标记点检测 (2D Marker Detection)

1.  **输入**: 原始 IR 图像 ($I_{ir}$)。
2.  **阈值分割**: 应用超高阈值 $T_{high} \approx 60000$。
    $$ M_{bin} = I_{ir} > T_{high} $$
3.  **连通域分析**: 寻找 $M_{bin}$ 中的连通区域。
4.  **筛选**: 只有当检测到 **2个** 符合面积要求的连通域时，才继续。
5.  **质心计算**: 获取两个连通域的质心 $p_1(u_1, v_1)$ 和 $p_2(u_2, v_2)$。这两个点代表笔尖和笔尾在图像平面的投影。

### 3.2 笔杆区域采样 (ROI Sampling)

1.  **定义采样线段**: 连接 $p_1$ 和 $p_2$ 形成线段 $L_{2D}$。
2.  **定义采样掩膜**:
    - **动态宽度**: $ROI\_width = \text{avg}(radius(p_1), radius(p_2)) \times \text{ROI\_SCALE}$。
    - 由于笔在不同距离下在图像上的粗细不同，使用固定像素宽度会导致近处采样不足或远处采样背景。光斑半径（$radius$）与笔杆粗细成正比，是一个良好的自适应指标。
    - 以 $L_{2D}$ 为中心轴，宽度为 $ROI\_width$ 的矩形区域作为感兴趣区域 (ROI)。
3.  **深度采样**:
    - 遍历 ROI 内的所有像素 $(u_i, v_i)$。
    - 读取对应的深度值 $d_i = D(u_i, v_i)$。
    - **初步过滤**:
        - 剔除 $d_i = 0$ (无效深度)。
        - 剔除 $d_i$ 接近 $p_1, p_2$ 处深度的点（因为标记点附近深度不可靠）。更简单的做法是：只取线段 $p_1 p_2$ 中间 60%-80% 的区域进行采样，避开两端的高反干扰区。

### 3.3 3D 点云构建 (Point Cloud Generation)

对于 ROI 内每一个有效采样点 $(u_i, v_i, d_i)$，利用相机内参 $K$ 反投影到 3D 空间：

$$ P_i = \begin{bmatrix} x_i \\ y_i \\ z_i \end{bmatrix} = d_i \cdot K^{-1} \begin{bmatrix} u_i \\ v_i \\ 1 \end{bmatrix} $$

得到一组 3D 点集 $\mathcal{P} = \{P_1, P_2, ..., P_N\}$。这些点大致分布在笔杆圆柱的表面。

### 3.4 鲁棒直线拟合 (Robust Line Fitting)

目标是找到一条 3D 直线 $L_{3D}$，使得点集 $\mathcal{P}$ 到直线的距离最小。由于深度图可能包含噪点（背景、手部遮挡等），需使用鲁棒估计算法。

- **方法 A: RANSAC (推荐)**
    1. 随机选取两个点，确定一条直线。
    2. 计算所有点到该直线的距离。
    3. 统计“内点”（距离小于阈值，如 5mm）的数量。
    4. 重复多次，取内点最多的直线模型。
    5. 对所有内点进行最小二乘再优化，得到最终的方向向量 $\vec{v}$ 和直线上一点 $C$。

- **方法 B: PCA (主成分分析)**
    - 适用于噪声较少的情况。计算点云协方差矩阵，最大特征值对应的特征向量即为笔杆主方向。需先剔除离群点。

### 3.5 标记点 3D 修正 (Marker 3D Reconstruction)

现在我们有了：
1. 精确的 2D 观测点 $p_1, p_2$。
2. 拟合出的 3D 直线 $L_{3D}$（由点 $C$ 和方向 $\vec{v}$ 定义）。

我们需要找到 $L_{3D}$ 上的一点 $P_{1}'$，使得 $P_{1}'$ 在图像平面的投影最接近 $p_1$。这等价于求 **视线（从相机光心 $O$ 穿过 $p_1$ 的射线）与 3D 直线 $L_{3D}$ 的公垂线中点**（或直接求交点，如果相交）。

由于测量误差，射线与 $L_{3D}$ 通常异面不相交。我们取射线到 $L_{3D}$ 距离最近的点作为 $P_{1}'$。

- **射线定义**: $R_1(t) = O + t \cdot \vec{d_1}$，其中 $\vec{d_1} = K^{-1} [u_1, v_1, 1]^T$。
- **求解**: 寻找 $P_{1}' \in L_{3D}$ 使得 dist($P_{1}'$, $R_1$) 最小。

同理计算 $P_{2}'$。

### 3.6 姿态输出 (Pose Output)

- **位置**: $P_{tip} = P_{1}'$ (假设 $p_1$ 对应笔尖)。
- **朝向**: $\vec{Direction} = \text{normalize}(P_{2}' - P_{1}')$。

## 4. 异常处理 (Corner Cases)

1.  **点数过少**: 如果 ROI 内有效深度点过少（如被手完全遮挡），则本次追踪失败 (LOST)。
2.  **拟合残差过大**: 如果 RANSAC 内点比例过低，说明笔杆深度数据质量差，判定为 LOST。
3.  **笔杆长度校验**: 计算 $\|P_{1}' - P_{2}'\|$，应接近物理笔长（如 20cm）。偏差过大则丢弃。

## 5. 待定参数 (Parameters)

| 参数名 | 典型值 | 说明 |
| :--- | :--- | :--- |
| `IR_THRESHOLD` | 60000 | IR 图像二值化阈值 |
| `ROI_WIDTH_PX` | 15 | 采样路径宽度 |
| `SAMPLE_MARGIN` | 0.2 | 避开首尾标记点的比例 (0.2 表示去掉头尾各 20%) |
| `RANSAC_THRESH` | 0.005 | RANSAC 距离阈值 (单位: 米) |
| `PEN_LENGTH_TOLERANCE` | 0.03 | 笔长容差 (单位: 米) |
